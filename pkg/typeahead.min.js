JX.install('Typeahead',{construct:function(b,a){this._hardpoint=b;this._control=a||JX.DOM.find(b,'input');this._root=JX.$N('div',{className:'jx-typeahead-results'});this._display=[];JX.DOM.listen(this._control,['focus','blur','keypress','keydown'],null,JX.bind(this,this.handleEvent));JX.DOM.listen(this._root,['mouseover','mouseout'],null,JX.bind(this,this._onmouse));JX.DOM.listen(this._root,'mousedown','tag:a',JX.bind(this,function(c){this._choose(c.getNode('tag:a'));c.prevent();}));},events:['choose','query','start','change'],properties:{allowNullSelection:true,normalizer:null},members:{_root:null,_control:null,_hardpoint:null,_value:null,_stop:false,_focus:-1,_display:null,start:function(){this.invoke('start');},setDatasource:function(a){a.bindToTypeahead(this);},setInputNode:function(a){this._control=a;return this;},hide:function(){this._changeFocus(Number.NEGATIVE_INFINITY);this._display=[];this._moused=false;JX.DOM.setContent(this._root,'');JX.DOM.remove(this._root);},showResults:function(b){this._display=b;if(b.length){JX.DOM.setContent(this._root,b);this._changeFocus(Number.NEGATIVE_INFINITY);var a=JX.$V.getDim(this._hardpoint);a.x=0;a.setPos(this._root);this._hardpoint.appendChild(this._root);}else this.hide();},refresh:function(){if(this._stop)return;this._value=this._control.value;!this.invoke('change',this._value).getPrevented();},waitForResults:function(){this.hide();},_onmouse:function(event){this._moused=(event.getType()=='mouseover');this._drawFocus();},_changeFocus:function(a){var b=Math.min(Math.max(-1,this._focus+a),this._display.length-1);if(!this.getAllowNullSelection())b=Math.max(0,b);if(this._focus>=0&&this._focus<this._display.length)JX.DOM.alterClass(this._display[this._focus],'focused',0);this._focus=b;this._drawFocus();return true;},_drawFocus:function(){var a=this._display[this._focus];if(a)JX.DOM.alterClass(a,'focused',!this._moused);},_choose:function(b){var a=this.invoke('choose',b);if(a.getPrevented())return;this._control.value=b.name;this.hide();},clear:function(){this._control.value='';this.hide();},disable:function(){this._control.blur();this._control.disabled=true;this._stop=true;},submit:function(){if(this._focus>=0&&this._display[this._focus]){this._choose(this._display[this._focus]);return true;}else{result=this.invoke('query',this._control.value);if(result.getPrevented())return true;}return false;},setValue:function(a){this._control.value=a;},getValue:function(){return this._control.value;},_update:function(event){var a=event&&event.getSpecialKey();if(a&&event.getType()=='keydown')switch(a){case 'up':if(this._display.length&&this._changeFocus(-1))event.prevent();break;case 'down':if(this._display.length&&this._changeFocus(1))event.prevent();break;case 'return':if(this.submit()){event.prevent();return;}break;case 'esc':if(this._display.length&&this.getAllowNullSelection()){this.hide();event.prevent();}break;case 'tab':return;}JX.defer(JX.bind(this,function(){if(this._value==this._control.value)return;this.refresh();}));},handleEvent:function(a){if(this._stop||a.getPrevented())return;var b=a.getType();if(b=='blur'){this.hide();}else this._update(a);}}});JX.install('TypeaheadNormalizer',{statics:{normalize:function(a){return (''+a).toLowerCase().replace(/[^a-z0-9 ]/g,'').replace(/ +/g,' ').replace(/^\s*|\s*$/g,'');}}});JX.install('TypeaheadSource',{construct:function(){this._raw={};this._lookup={};this.setNormalizer(JX.TypeaheadNormalizer.normalize);},properties:{normalizer:null,transformer:null,maximumResultCount:5},members:{_raw:null,_lookup:null,_typeahead:null,_normalizer:null,bindToTypeahead:function(a){this._typeahead=a;a.listen('change',JX.bind(this,this.didChange));a.listen('start',JX.bind(this,this.didStart));},didChange:function(a){return;},didStart:function(){return;},clearCache:function(){this._raw={};this._lookup={};},addResult:function(b){b=(this.getTransformer()||this._defaultTransformer)(b);if(b.id in this._raw)return;this._raw[b.id]=b;var c=this.tokenize(b.name);for(var a=0;a<c.length;++a){this._lookup[c[a]]=this._lookup[c[a]]||[];this._lookup[c[a]].push(b.id);}},waitForResults:function(){this._typeahead.waitForResults();return this;},matchResults:function(q){var h={};var i={};var k={};var o={};var p=this.tokenize(q);p.sort(function(r,s){return s.length-r.length;});for(var c=0;c<p.length;++c){if(p[c] in o){p.splice(c--,1);continue;}o[p[c]]=true;var a=p[c];for(var m in this._lookup)if(m.substr(0,a.length)===a){if(!(m in k)){k[m]=true;}else continue;var g=this._lookup[m];for(var d=0;d<g.length;++d){var j=g[d];if(!i[j])i[j]={};if(!(a in i[j])){i[j][a]=true;h[j]=(h[j]||0)+1;}}}}var b=[];for(var e in h)if(h[e]==p.length)b.push(e);var l=Math.min(this.getMaximumResultCount(),b.length);var n=[];for(var f=0;f<l;f++)n.push(this.createNode(this._raw[b[f]]));this._typeahead.showResults(n);},createNode:function(a){return JX.$N('a',{href:a.uri,name:a.name,rel:a.id,className:'jx-result'},a.display);},normalize:function(a){return (this.getNormalizer()||JX.bag())(a);},tokenize:function(a){a=this.normalize(a);if(!a.length)return [];return a.split(/ /g);},_defaultTransformer:function(a){return {name:a[0],display:a[0],uri:a[1],id:a[2]};}}});JX.install('TypeaheadPreloadedSource',{extend:'TypeaheadSource',construct:function(a){JX.TypeaheadSource.call(this);this.uri=a;},members:{ready:false,uri:null,lastValue:null,didChange:function(a){if(this.ready){this.matchResults(a);}else{this.lastValue=a;this.waitForResults();}JX.Stratcom.context().kill();},didStart:function(){var a=new JX.Request(this.uri,JX.bind(this,this.ondata));a.setMethod('GET');a.send();},ondata:function(b){for(var a=0;a<b.length;++a)this.addResult(b[a]);if(this.lastValue!==null)this.matchResults(this.lastValue);this.ready=true;}}});JX.install('TypeaheadOnDemandSource',{extend:'TypeaheadSource',construct:function(a){JX.TypeaheadSource.call(this);this.uri=a;this.haveData={'':true};},properties:{queryDelay:125,auxiliaryData:{}},members:{uri:null,lastChange:null,haveData:null,didChange:function(a){if(JX.Stratcom.pass())return;this.lastChange=new Date().getTime();a=this.normalize(a);if(this.haveData[a]){this.matchResults(a);}else{this.waitForResults();JX.defer(JX.bind(this,this.sendRequest,this.lastChange,a),this.getQueryDelay());}JX.Stratcom.context().kill();},sendRequest:function(c,b){if(c!=this.lastChange)return;var a=new JX.Request(this.uri,JX.bind(this,this.ondata,this.lastChange,b));a.setMethod('GET');a.setData(JX.copy(this.getAuxiliaryData(),{q:b}));a.send();},ondata:function(d,c,b){for(var a=0;a<b.length;a++)this.addResult(b[a]);this.haveData[c]=true;if(d!=this.lastChange)return;this.matchResults(c);}}});JX.install('Tokenizer',{construct:function(a){this._containerNode=a;},properties:{limit:null,nextInput:null},members:{_containerNode:null,_root:null,_focus:null,_orig:null,_typeahead:null,_tokenid:0,_tokens:null,_tokenMap:null,_initialValue:null,_seq:0,_lastvalue:null,start:function(){this._orig=JX.DOM.find(this._containerNode,'input','tokenizer');this._tokens=[];this._tokenMap={};var a=this.buildInput(this._orig.value);this._focus=a;JX.DOM.listen(a,['click','focus','blur','keydown'],null,JX.bind(this,this.handleEvent));JX.DOM.listen(this._containerNode,'click',null,JX.bind(this,function(d){if(d.getNode('remove')){this._remove(d.getNodeData('token').key);}else if(d.getTarget()==this._root)this.focus();}));var b=JX.$N('div');b.id=this._orig.id;JX.DOM.alterClass(b,'jx-tokenizer',true);b.style.cursor='text';this._root=b;b.appendChild(a);var c=this._typeahead;c.setInputNode(this._focus);c.start();JX.defer(JX.bind(this,function(){var d=this._orig.parentNode;JX.DOM.setContent(d,b);var f=this._initialValue||{};for(var e in f)this.addToken(e,f[e]);JX.DOM.appendContent(d,JX.$N('div',{style:{clear:'both'}}));this._redraw();}));},setInitialValue:function(a){this._initialValue=a;return this;},setTypeahead:function(a){a.setAllowNullSelection(false);a.listen('choose',JX.bind(this,function(b){JX.Stratcom.context().prevent();if(this.addToken(b.rel,b.name)){this._typeahead.hide();this._focus.value='';this._redraw();this.focus();}}));a.listen('query',JX.bind(this,function(b){if(b.length)JX.Stratcom.context().prevent();}));this._typeahead=a;return this;},handleEvent:function(a){this._typeahead.handleEvent(a);if(a.getPrevented())return;if(a.getType()=='click'){if(a.getTarget()==this._root){this.focus();a.prevent();return;}}else if(a.getType()=='keydown'){this._onkeydown(a);}else if(a.getType()=='blur')this._redraw();},refresh:function(){this._redraw(true);return this;},_redraw:function(b){var a=this._focus;if(a.value===this._lastvalue&&!b)return;this._lastvalue=a.value;var d=this._root;var c=JX.DOM.textMetrics(this._focus,'jx-tokenizer-metrics');c.y=null;c.x+=24;c.setDim(a);a.value=a.value;},addToken:function(b,e){if(b in this._tokenMap)return false;var a=this._focus;var c=this._root;var d=this.buildToken(b,e);this._tokenMap[b]={value:e,key:b,node:d};this._tokens.push(b);c.insertBefore(d,a);return true;},buildInput:function(a){return JX.$N('input',{className:'jx-tokenizer-input',type:'text',value:a});},buildToken:function(b,d){var a=JX.$N('input',{type:'hidden',value:b,name:this._orig.name+'['+(this._seq++)+']'});var c=JX.$N('a',{className:'jx-tokenizer-x',sigil:'remove'},JX.HTML('&times;'));return JX.$N('a',{className:'jx-tokenizer-token',sigil:'token',meta:{key:b}},[d,a,c]);},getTokens:function(){var b={};for(var a in this._tokenMap)b[a]=this._tokenMap[a].value;return b;},_onkeydown:function(b){var c=this._focus;var d=this._root;switch(b.getSpecialKey()){case 'tab':var a=this._typeahead.submit();if(this.getNextInput()){if(!a)this._focus.value='';JX.defer(JX.bind(this,function(){this.getNextInput().focus();}));}break;case 'delete':if(!this._focus.value.length){var e;while(e=this._tokens.pop())if(this._remove(e))break;}break;case 'return':break;default:if(this.getLimit()&&JX.keys(this._tokenMap).length==this.getLimit())b.prevent();JX.defer(JX.bind(this,this._redraw));break;}},_remove:function(a){if(!this._tokenMap[a])return false;JX.DOM.remove(this._tokenMap[a].node);delete this._tokenMap[a];this._redraw(true);this.focus();return true;},focus:function(){var a=this._focus;JX.DOM.show(a);JX.defer(function(){JX.DOM.focus(a);});}}});